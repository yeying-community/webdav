# 资产空间分层实施清单（可执行）

本文档将《asset-space-design.md》拆解为可执行任务，按阶段推进。  
目标：上线“个人资产（personal）/ 应用资产（apps）”双空间，并保证第三方 WebDAV 客户端与 UCAN 规则兼容。

## 0. 里程碑与完成定义

里程碑：

1. M1（后端能力就绪）：目录初始化 + 空间元信息接口 + 权限边界
2. M2（前端入口就绪）：登录后双入口与路径体验
3. M3（迁移上线）：存量迁移、灰度发布、回滚预案

完成定义（DoD）：

- 新用户注册后自动拥有 `personal/` 与 `apps/`
- 登录后可见“个人资产 / 应用资产”双入口
- UCAN `app:<appId>` 仅可访问 `/apps/<appId>/...`
- 存量用户迁移完成且可回滚
- 文档/API/运维说明同步完成

## 1. 阶段一：规范冻结（T+0）

- [ ] 1.1 目录命名冻结为 `personal` + `apps`
  - 验收：评审通过并记录到 `asset-space-design.md`
- [ ] 1.2 appId 规范冻结（推荐域名主机部分）
  - 验收：UCAN 文档与前端示例一致
- [ ] 1.3 访问边界冻结（JWT 与 UCAN）
  - 验收：明确“UCAN app scope 仅约束 apps，不开放 personal”

## 2. 阶段二：后端改造（M1）

## 2.1 用户目录初始化

- [x] 2.1.1 注册成功后创建 `/<user_root>/personal`
- [x] 2.1.2 注册成功后创建 `/<user_root>/apps`
- [x] 2.1.3 登录时兜底自愈缺失目录（幂等）
  - 验收：新老用户首次登录均可看到两目录，无报错

## 2.2 空间元信息接口

- [x] 2.2.1 新增接口：`GET /api/v1/public/assets/spaces`
- [x] 2.2.2 返回默认空间与展示名称（`personal`/`apps`）
- [x] 2.2.3 接口权限接入现有鉴权体系
  - 验收：前端可无硬编码渲染双入口

## 2.3 权限与 UCAN 边界

- [x] 2.3.1 校验 `app:<appId>` 仅匹配 `/apps/<appId>/...`
- [x] 2.3.2 拒绝 `app:*` 或 `app:xxx*` 作为客户端 cap（文档与服务端日志提示）
- [x] 2.3.3 MOVE/COPY 双路径校验（源与目标都必须满足）
  - 验收：跨 app 未授权访问返回 403，日志可定位

## 2.4 测试补充（后端）

- [x] 2.4.1 单测：新用户目录初始化
- [x] 2.4.2 集成测试：UCAN app scope + WebDAV 方法映射
- [x] 2.4.3 回归：JWT 登录与非 UCAN 路径不受破坏
  - 验收：CI 通过，关键链路有自动化覆盖

## 3. 阶段三：前端改造（M2）

## 3.1 导航与默认入口

- [ ] 3.1.1 新增一级入口：`个人资产`、`应用资产`
- [ ] 3.1.2 默认进入 `personal`
- [ ] 3.1.3 面包屑显示空间标签（个人/DApp）
  - 验收：登录后首次路径为 `/personal`，可切换到 `/apps`

## 3.2 应用资产视图

- [ ] 3.2.1 `/apps` 首层展示 app 目录列表
- [ ] 3.2.2 支持进入 `/apps/<appId>/...` 文件管理
- [ ] 3.2.3 对“当前 appId”提供快速过滤/高亮（可选）
  - 验收：用户可独立管理个人与应用空间

## 3.3 前端接口接入

- [ ] 3.3.1 接入 `GET /assets/spaces` 渲染入口
- [ ] 3.3.2 保持旧路径兼容（降级到硬编码）
  - 验收：接口异常时仍可用，不阻断主流程

## 3.4 测试补充（前端）

- [ ] 3.4.1 手测矩阵：桌面/移动、钱包/密码/邮箱登录
- [ ] 3.4.2 手测矩阵：personal/apps 切换、上传下载、回收站
- [ ] 3.4.3 兼容性：Finder/Windows/rclone 挂载后目录可见
  - 验收：关键路径无阻塞问题

## 4. 阶段四：存量迁移（M3）

## 4.1 迁移脚本

- [ ] 4.1.1 编写迁移脚本（支持 dry-run）
- [ ] 4.1.2 规则：根目录业务文件迁移到 `personal/`
- [ ] 4.1.3 白名单：`apps/` 与系统目录不迁移
  - 验收：dry-run 报告与实际结果一致

## 4.2 灰度发布

- [ ] 4.2.1 预发环境全量迁移与回归
- [ ] 4.2.2 生产小流量用户灰度（5% -> 20% -> 100%）
- [ ] 4.2.3 监控错误率、401/403、上传失败率
  - 验收：指标稳定，无大规模回退

## 4.3 回滚预案

- [ ] 4.3.1 保留迁移前目录快照/备份
- [ ] 4.3.2 提供回滚脚本与操作手册
- [ ] 4.3.3 设置回滚触发阈值
  - 验收：可在演练中完成回滚

## 5. 文档与对外集成

- [ ] 5.1 更新 API 文档（`webdav-api.md`）增加空间接口与示例
- [ ] 5.2 更新 UCAN 文档（apps 访问规则与示例）
- [ ] 5.3 更新部署文档（目录初始化与迁移注意事项）
- [ ] 5.4 发布第三方集成指南（DApp 仅访问自身 app 目录）
  - 验收：文档索引完整，前后端示例一致

## 6. 建议排期（参考）

1. 周 1：规范冻结 + 后端初始化/接口开发
2. 周 2：前端双入口 + 权限回归 + 预发联调
3. 周 3：存量迁移演练 + 灰度上线 + 文档收口

## 7. 风险清单

- 风险：存量目录复杂，迁移误伤  
  应对：强制 dry-run + 白名单 + 快照回滚

- 风险：第三方客户端缓存旧路径  
  应对：保留根目录兼容期，发布迁移公告

- 风险：DApp cap 过宽导致越权  
  应对：禁止通配 cap，日志输出 required/provided caps

---

关联文档：

- `asset-space-design.md`
- `ucan.md`
- `webdav-flow.md`
